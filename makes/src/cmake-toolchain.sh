#! /usr/bin/env bash

set -e

TARGET_ARGS_C=(
    "--config \${CMAKE_CURRENT_LIST_DIR}/bin/${TARGET_TUPLE}.cfg"
    "--sysroot=\${CMAKE_CURRENT_LIST_DIR}/${TARGET_TUPLE}"
    "-L \${CMAKE_CURRENT_LIST_DIR}/${TARGET_TUPLE}/usr/lib/${TARGET_TUPLE}/${V_GCC}"
    "-B \${CMAKE_CURRENT_LIST_DIR}/${TARGET_TUPLE}/usr/lib/${TARGET_TUPLE}/${V_GCC}"
)
TARGET_ARGS_CXX=(
    "${TARGET_ARGS_C[@]}"
    "-I \${CMAKE_CURRENT_LIST_DIR}/${TARGET_TUPLE}/usr/include/c++/v1"
)
TARGET_ARGS_C_STR="${TARGET_ARGS_C[@]}"
TARGET_ARGS_CXX_STR="${TARGET_ARGS_CXX[@]}"

TOOLCHAIN_CMAKE_OUT=cmake-toolchain.cmake

cat << EOF > ${TOOLCHAIN_CMAKE_OUT}
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR arm)
set(CMAKE_SYSTEM_VERSION 1)

set(GCC_COMPILER_VERSION "${V_LLVM}" CACHE STRING "Clang Compiler version")
set(GNU_MACHINE "${TARGET_TUPLE}" CACHE STRING "GNU compiler triple")

set(CMAKE_C_COMPILER \${CMAKE_CURRENT_LIST_DIR}/bin/clang)
set(CMAKE_C_COMPILER_TARGET \${GNU_MACHINE})
set(CMAKE_CXX_COMPILER \${CMAKE_CURRENT_LIST_DIR}/bin/clang++)
set(CMAKE_CXX_COMPILER_TARGET \${GNU_MACHINE})
set(CMAKE_AR \${CMAKE_CURRENT_LIST_DIR}/bin/llvm-ar)
set(CMAKE_LINKER \${CMAKE_CURRENT_LIST_DIR}/bin/lld)

set(CMAKE_FIND_ROOT_PATH "\${CMAKE_CURRENT_LIST_DIR}/\${GNU_MACHINE}/")

set(CMAKE_C_FLAGS "$TARGET_ARGS_C_STR")
set(CMAKE_CXX_FLAGS "$TARGET_ARGS_CXX_STR")

# Use host tools
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)

# Only ever build/link to sysroot
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

EOF

cat $TOOLCHAIN_CMAKE_OUT
